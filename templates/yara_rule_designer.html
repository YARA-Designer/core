<!--suppress HtmlUnknownTarget -->
<link rel="stylesheet" href="{{ url_for('static', filename='yara_rule_designer.css') }}">

<!-- Define default values for variables  -->
{% if artifacts is not defined %}
    {% set artifacts = {"data:" : "ERROR: NO ARTIFACTS WERE GIVEN!"} %}
{% endif %}

<!-- Load theme if specified -->
{% if theme is defined %}
    <!-- Set Jinja2 variables for use in JavaScript -->
    <!--    Theme handler: -->
    <meta id="themeArg" data-name="{{ theme }}" data-path="{{ url_for('static', filename='themes') + '/' }}">
    <!--    JavaScript custom POST handler -->
    <meta id="postUrl" data-url="{{ url_for('post_rule_json') }}">
    <!--    YARA rule variables gathered from backend for use in POST request -->
    <meta id="yaraRule" data-name="Whitelist_{{ case.data.title }}" data-tags="{{ case.data.tags }}">
    <meta id="yaraMeta" data-description="Whitelist regler for alarmen: Whitelist_{{ case.data.title }}">
{% endif %}

<div class="container mh-100 h-100 mw-100 w-100 yara_rule_designer" id="yara_rule_designer_container">
    <div class="row align-items-start">

        <div id="yara_rule_designer_header" class="col yara_rule_designer">
            <p> Case: {{ case.data.title }} [ID: {{ case.data.id }}] </p>
        </div>

        <div class="w-100"></div>

        <div id="yara_rule_designer_leftpane_container" class="col-2 yara_rule_designer">
            <div class="row">
                <div class="row m-row justify-content-between yara_rule_designer" id="yara-rule-designer-buttons">
                    <button id="show-help-button" class="col-sm my-col" onclick="popupHelpModal()">Help</button>
                    <button id="clear-rule-button" class="col-sm my-col" onclick="clearRule()">Clear</button>
                    <button id="submit-rule-button" class="col-sm my-col" onclick="postRule()">Submit</button>
                </div>

                <div class="w-100"></div>

                <div id="yara-rule-designer-tags" class="yara_rule_designer">
                    {% for tag in case.data.tags %}
                        <input type="checkbox" id="tagCheckbox{{ loop.index|string }}" class="yara-tag-checkbox" value="{{ tag|string }}">
                        <label for="tagCheckbox{{ loop.index|string }}" title="{{ tag|string }}">{{ tag|string }}</label>
                        <div class="w-100"></div>
                    {% endfor %}
                </div>

                <div class="w-100"></div>

                <div class="yara_rule_designer" id="yara_rule_designer_operators">
                    <!--    Add conditional keywords-->
                    <!--    Boolean-->
                    <span id="condition_keyword_and" class="condition_keyword" onclick="addToEditor(event)">AND</span>
                    <span id="condition_keyword_or" class="condition_keyword" onclick="addToEditor(event)">OR</span>
                    <span id="condition_keyword_not" class="condition_keyword" onclick="addToEditor(event)">NOT</span>
                    <!--    Arithmetic-->
                    <span id="condition_keyword_equal" class="condition_keyword" onclick="addToEditor(event)">==</span>
                    <span id="condition_keyword_lt" class="condition_keyword" onclick="addToEditor(event)"><</span>
                    <span id="condition_keyword_gt" class="condition_keyword" onclick="addToEditor(event)">></span>
                    <span id="condition_keyword_leq" class="condition_keyword" onclick="addToEditor(event)"><=</span>
                    <span id="condition_keyword_geq" class="condition_keyword" onclick="addToEditor(event)">>=</span>
                    <span id="condition_keyword_neq" class="condition_keyword" onclick="addToEditor(event)">!=</span>
                    <!--    Relational-->
                    <span id="condition_keyword_add" class="condition_keyword" onclick="addToEditor(event)">+</span>
                    <span id="condition_keyword_sub" class="condition_keyword" onclick="addToEditor(event)">-</span>
                    <span id="condition_keyword_mul" class="condition_keyword" onclick="addToEditor(event)">*</span>
                    <span id="condition_keyword_div" class="condition_keyword" onclick="addToEditor(event)">/</span>
                    <span id="condition_keyword_pct" class="condition_keyword" onclick="addToEditor(event)">%</span>
                    <span id="condition_keyword_setminus" class="condition_keyword" onclick="addToEditor(event)">\</span>
                    <!--    Bitwise-->
                    <span id="condition_keyword_bitwise_and" class="condition_keyword" onclick="addToEditor(event)">&</span>
                    <span id="condition_keyword_bitwise_or" class="condition_keyword" onclick="addToEditor(event)">|</span>
                    <span id="condition_keyword_bitwise_not" class="condition_keyword" onclick="addToEditor(event)">~</span>
                    <span id="condition_keyword_bitwise_xor" class="condition_keyword" onclick="addToEditor(event)">^</span>
                    <span id="condition_keyword_bitwise_lshift" class="condition_keyword" onclick="addToEditor(event)"><<</span>
                    <span id="condition_keyword_bitwise_rshift" class="condition_keyword" onclick="addToEditor(event)">>></span>
                    <!-- Parenthesis and wrappers       -->
                    <span id="condition_keyword_lparen" class="condition_keyword" onclick="addToEditor(event)">(</span>
                    <span id="condition_keyword_rparen" class="condition_keyword" onclick="addToEditor(event)">)</span>
                    <span id="condition_keyword_encapsulate_paren" class="condition_encapsulator" onclick="addToEditor(event)">()</span>
                </div>

                <div class="w-100"></div>

                    {#  Add artifacts and artifact dataTypes as individual draggable objects #}

                    {# Define list to filter artifact types so that only unique occurrences are added. #}
                    {% set added_artifact_types = [] %}

                    {# For use in adding the HTML at a later time, to avoid looping multiple times. #}
                    {% set artifact_span_elements = [] %}
                    {% set artifact_type_span_elements = [] %}

                    {% for artifact in artifacts %}
                        {# Add artifacts #}
                        {{ artifact_span_elements.append("<span id='artifact" + loop.index|string + "' class='draggable_artifact' onclick='addToEditor(event)'>" + artifact.data|string + '</span>')|ignore_none }}


                        <!-- Add artifact dataTypes-->
                        <!-- Remove NoneType entries by assigning the value to a new variable, if it is not NoneType. -->
                        {% if artifact.dataType is not none and artifact.dataType != "None" %}
                            {% if artifact.dataType not in added_artifact_types %}
                                <!-- Only add unique items to editor -->
                                {# Add artifact types #}
                                {{ artifact_type_span_elements.append('<span id="artifact_type' + loop.index|string + '" class="draggable_artifact_type" onclick="addToEditor(event)">' + artifact.dataType|string + '</span>')|ignore_none }}
                                {{ added_artifact_types.append(artifact.dataType)|ignore_none }}
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                <div class="yara_rule_designer" id="yara_rule_designer_artifact_types">
                    {% for artifact_type_span_element in artifact_type_span_elements %}
                        {{ artifact_type_span_element|safe }}
                    {% endfor %}
                </div>

                <div class="w-100"></div>

                <div class="yara_rule_designer" id="yara_rule_designer_artifacts">
                    {% for artifact_span_element in artifact_span_elements %}
                        {{ artifact_span_element|safe }}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div id="yara_rule_designer_editor_container" class="col-10 yara_rule_designer">
            <div class="row">
                <div class="container col yara_rule_designer" id="yara_rule_designer_editor"></div>
            </div>
        </div>

    </div> <!-- Row //-->
</div> <!-- Container //-->

<!-- Pre-define default modals (to be populated by JavaScript later). -->
<div id="response-modal" class="custom-modal">
    <!-- Modal content -->
    <div class="custom-modal-content">
      <div class="custom-modal-header" id="response-modal-header">
        <span class="close-custom-modal" id="response-modal-close">&times;</span>
        <h2>Modal Header</h2>
      </div>
      <div class="custom-modal-body" id="response-modal-body">
        <p>Some text in the Modal Body</p>
        <p>Some other text...</p>
      </div>
      <div class="custom-modal-footer" id="response-modal-footer">
        <h3>Modal Footer</h3>
      </div>
    </div>
</div>

<div id="confirmation-modal" class="custom-modal">
    <!-- Modal content -->
    <div class="custom-modal-content">
        <div class="custom-modal-header" id="confirmation-modal-header">
            <span class="close-custom-modal" id="confirmation-modal-close">&times;</span>
            <h2>Modal Header</h2>
        </div>
        <div class="custom-modal-body" id="confirmation-modal-body">
            <p>Some text in the Modal Body</p>
            <p>Some other text...</p>
        </div>
        <div class="custom-modal-footer" id="confirmation-modal-footer">
            <h3>Modal Footer</h3>
        </div>
    </div>
</div>

{% block javascript %}
    <!-- JQuery ( required for Bootstrap and $() ). -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT" crossorigin="anonymous"></script>

    <!-- Popper ( required for Bootstrap ). -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    <!-- Dragula - Drag 'n Drop   -->
    <!--suppress HtmlUnknownTarget -->
    <link rel="stylesheet" href="{{ url_for('static', filename='dragula.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js" integrity="sha384-BCXeg8w0rlmhmi8L/zjAIsj0b66prXjptd1vMdGJbEVJH5aBJYDjzfdTmWBzcCXG" crossorigin="anonymous"></script>

    <!-- Theme handler -->
    <script>
        // extend jQuery with this tiny convenience to allow for simple existence tests.
        $.fn.exists = function () {
            return this.length !== 0;
        };

        function loadTheme(themeName, themePath) {
            const rootEl = document.querySelector(':root');

            let themeFile = themeName + ".json";
            let themeFilePath = themePath + themeFile;

            // Load corresponding theme JSON from file.
            console.log("Load theme: " + themeFilePath);
            $.getJSON(themeFilePath, function(json) {
                console.log(json); // this will show the info it in firebug console
                for (let key in json) {
                    if (json.hasOwnProperty(key)) {
                        console.log("setProperty(" + key + ", " + json[key] + ")");
                        rootEl.style.setProperty(key, json[key]);
                    }
                }

            });
        }

        let themeArg = $('#themeArg');

        if (themeArg.exists()) {
            loadTheme(themeArg.data().name, themeArg.data().path)
        }
    </script>

    <!-- Core script block -->
    <script>
        // https://stackoverflow.com/a/26272668
        function getStyleRuleValue(selector, style) {
         let selector_compare=selector.toLowerCase();
         let selector_compare2= selector_compare.substr(0,1)==='.' ?  selector_compare.substr(1) : '.'+selector_compare;

         for (let i = 0; i < document.styleSheets.length; i++)
         {
          let mysheet = document.styleSheets[i];
          let myrules = mysheet.cssRules ? mysheet.cssRules : mysheet.rules;

          for (let j = 0; j < myrules.length; j++)
          {
            if (myrules[j].selectorText)
            {
             let check = myrules[j].selectorText.toLowerCase();
             switch (check)
             {
              case selector_compare  :
              case selector_compare2 : return myrules[j].style[style];
             }
            }
           }
          }
         }

        const ROOT_CLASS = 'yara_rule_designer';
        const DIVS_WITH_CLONING = ['yara_rule_designer_artifacts', 'yara_rule_designer_operators'];
        const SUCCESS_ICON = "<span style='color: green'>&#10003;</color>";
        const FAILED_ICON = "<span style='color: red'>&#10005;</span>";
        const YARA_VARIABLE_DENOMINATOR = "$";

        let originalParentIdLookupByClass = {
            "draggable_artifact": "yara_rule_designer_artifacts",
            "condition_keyword": "yara_rule_designer_operators",
            "condition_encapsulator": "yara_rule_designer_operators"
        };

        // Convenience/readability constants.
        const LEFT_CLICK = 0;
        const MIDDLE_CLICK = 1;
        const RIGHT_CLICK = 2;
        const ARTIFACT_CLASSES = ["draggable_artifact", "draggable_artifact_type"];
        const KEYWORD_CLASSES = ["condition_keyword"];
        const MODAL_DEFAULT_HEADER = "";
        const MODAL_DEFAULT_BODY = "";
        const MODAL_DEFAULT_FOOTER = "<p>Tip: Click anywhere outside of this modal to cancel the current operation.</p>";
        const MODAL_DEFAULT_CONFIRMATION_HEADER = "<h2>Are you sure?</h2>";
        const MODAL_DEFAULT_CONFIRMATION_BODY = "";
        const MODAL_DEFAULT_CONFIRMATION_FOOTER = MODAL_DEFAULT_FOOTER;
        const LEVEL_ERROR = "error";
        const LEVEL_WARNING = "warning";
        const LEVEL_SUCCESS = "success";

        /////////////////////////////////// Dragula - drag 'n Drop //////////////////////////////////////////

        dragula([document.getElementById('yara_rule_designer_editor')]);

        ///////////////// Response modal globals (Re-implementations and listeners) ////////////////////////

        // Get the modals
        let modals = [];
        let modal_ids = ["response-modal", "confirmation-modal"];
        for (let i = 0; i < modal_ids.length; i++ ) {
            // Reset modals list (just in case, since we're running in global scope).
            // modals = [];

            // Add modals by-id.
            modals.push(document.getElementById(modal_ids[i]));
            console.log("pushed: " + modal_ids[i]);

           // Add close logic.
           let closeCustomModal = document.getElementById(modal_ids[i] + "-close");//[i];

           // When the user clicks on <span> (x), close (hide) the modal
           document.getElementById(modal_ids[i] + "-close").onclick = function() {
             document.getElementById(modal_ids[i]).style.display = "none";
           };

           // When the user clicks anywhere outside of the modal, close it
            window.onclick = function (event) {
                for (let i = 0; i < modal_ids.length; i++) {
                    if (event.target === document.getElementById(modal_ids[i])) {
                        document.getElementById(modal_ids[i]).style.display = "none";
                    }
                }
            };
        }

        /**
         * Convenience: Shortens the line width when getting a CSS variable.
         */
        function getCSSVar(varName) {
            // console.log("getCSSVar(" + varName + ") = " + getComputedStyle(document.documentElement).getPropertyValue('--' + varName));
            return getComputedStyle(document.documentElement).getPropertyValue('--' + varName);
        }

        /**
         * Shows a pop-up modal with customisable header, footer and body,
         * as well as background color based on level.
         *
         * level: String that is appended to CSS variables:
         *  - '-modal_background_*'
         *  - '-modal_color_*'
         */
        function popupModal(modal_id=null, header=null, body=null, footer=null, level=null) {
            // console.log("function popupModal(header=" + header + ", body=" + body + ", footer=" + footer + ", level=" + level + ")");
            // Modal element itself.
            let modal = document.getElementById(modal_id);

            // Modal sub-elements.
            let modalHeader = document.getElementById(modal_id + "-header");
            let modalBody = document.getElementById(modal_id + "-body");
            let modalFooter = document.getElementById(modal_id + "-footer");

            // Set level (if null, set to info/default).
            level = (level != null) ? level : "info";
            console.log("level:" + level);

            // Set sub-element values, if given.
            modalHeader.innerHTML = (header != null) ? header: MODAL_DEFAULT_HEADER;
            modalBody.innerHTML  = (body != null) ? body : MODAL_DEFAULT_BODY;
            modalFooter.innerHTML = (footer != null) ? footer :  MODAL_DEFAULT_FOOTER;

            // Set custom style.
            //      Header.
            modalHeader.style.background = getCSSVar("modal_background_" + level);
            modalHeader.style.color = getCSSVar("modal_color_" + level);
            //      Footer.
            modalFooter.style.background = getCSSVar("modal_background_" + level);
            modalFooter.style.color = getCSSVar("modal_color_" + level);

            // Show modal.
            modal.style.display = "block";

            // Return the modal to be easily used by caller.
            return modal;
        }

        /**
        *   Adds Yes/No confirmation buttons to a custom modal and binds actions to them.
        */
        function popupConfirmationModal(yesAction, noAction=undefined,
                                        body=MODAL_DEFAULT_CONFIRMATION_BODY,
                                        header=MODAL_DEFAULT_CONFIRMATION_HEADER,
                                        footer=MODAL_DEFAULT_CONFIRMATION_FOOTER,
                                        level=LEVEL_WARNING) {

            // Append bindable buttons to custom body.
            body += `<button id="confirmation-modal-button-yes-onclick" class="confirmation-modal-button-yes">Yes</button>`;
            body += `<button id="confirmation-modal-button-no-onclick" class="confirmation-modal-button-no">No</button>`;

            // Spawn modal.
            popupModal("confirmation-modal", header, body, footer, level);

            // Add bindings to buttons.
            document.getElementById("confirmation-modal-button-yes-onclick").onclick = function() {
                // Perform bound action (if defined).
                yesAction && yesAction();

                // Close modal.
                document.getElementById("confirmation-modal").style.display = "none";
            };
            document.getElementById("confirmation-modal-button-no-onclick").onclick = function() {
                // Perform bound action (if defined).
                noAction && noAction();

                // Close modal.
                document.getElementById("confirmation-modal").style.display = "none";
            };
        }

        function popupHelpModal() {
            let header = "<h2>How to use.</h2>";
            let body =
                    "<ul>" +
                    "<li>Click on items in the left-pane to add them to the editor.</li>" +
                    "<li>Middle mouse-click on an item in the editor to remove it.</li>" +
                    "</ul>";

            popupModal("response-modal", header, body, null, "info");

        }

        ///////////////////////////////////// Core (designer) code ///////////////////////////////////

        /**
         * Override default behaviour for mouse clicks in the editor div,
         * in order to support middle and right clicks.
         */
        document.getElementById('yara_rule_designer_editor').addEventListener('auxclick', function(ev) {
          console.log(ev.button);
          // Prevent default action in order to implement our own.
          ev.preventDefault();

          // Handle aux click events.
          onAuxClick(ev);
        });

        /**
         * Because null == undefined is true, this will catch both null and undefined.
         */
        function hasRelatedTarget(ev) {
            return ev.relatedTarget != null;
        }

        /**
         * Because null == undefined is true, this will catch both null and undefined.
         */
        function hasTarget(ev) {
            return ev.target != null;
        }

        /**
         * Get the identifying property of the item when getAttribute isn't inherited.
         */
        function getIdentifier(target) {
            if (target.nodeName === "#text") {
                return target.data + " [type: #text]";
            } else {
                return target.getAttribute('id');
            }
        }

        function addToEditor(clickEvent) {
            let editorDiv = document.getElementById("yara_rule_designer_editor");

            // If target is already in the editor, ignore the click event.
            if (clickEvent.target.parentNode.getAttribute("id") === "yara_rule_designer_editor") {
                console.log("Ignored click event (target is child of editor div):");
                console.log(clickEvent);
                return
            }

            // console.log(clickEvent);


            console.log('addToEditor: ' + $(clickEvent.target).text());
            editorDiv.appendChild(makeClone(clickEvent.target));
        }

        function removeFromEditor(clickEvent) {
            let editorDiv = document.getElementById("yara_rule_designer_editor");

            // Only perform remove action if target is a child of editor div.
            if (clickEvent.target.parentNode.getAttribute("id") === "yara_rule_designer_editor") {
                console.log("removeFromEditor: " + $(clickEvent.target).text());
                editorDiv.removeChild(clickEvent.target);
            }
        }

        function onAuxClick(auxClickEvent) {
            console.log("onAuxClick:");
            console.log(auxClickEvent);

            // Check which mouse button was pressed and act accordingly.
            switch (auxClickEvent.button) {
                case MIDDLE_CLICK:
                    removeFromEditor(auxClickEvent);
                    break;
                case RIGHT_CLICK:
                    break;
            }
        }

        function getEditorContents() {
            return document.getElementById("yara_rule_designer_editor").children;
        }

        function getEditorArtifactsAndTypes(unique=true) {
            let artifacts = [];
            let children = getEditorContents();

            for (let i = 0; i < children.length; i++) {
                if ( ARTIFACT_CLASSES.includes(children[i].className) ) {
                    if (unique === true) {
                        // If unique is specified, omit duplicate entries.
                        if ( !artifacts.some(child => child.id === children[i].id) ) {
                            artifacts.push(children[i]);
                        }
                    } else {
                        artifacts.push(children[i]);
                    }
                }
            }

            return artifacts;
        }

        function getEditorElementArtifactText(element) {
            // Get text string.
            return $(element).text();
        }

        function getEditorElementKeywordText(element) {
            // Get text string.
            return $(element).text();
        }

        function getEditorConditionString() {
            let conditionString = "";
            let children = getEditorContents();

            // Spacing to use in front of a word, to form a coherent sentence structure.
            let preSpacing = "";
            for (let i = 0; i < children.length; i++) {
                if (i === 1) {
                    // If we're past the first entry we can start prepending spacing.
                    preSpacing = " ";
                }

                // If child is of the artifact family.
                if ( ARTIFACT_CLASSES.includes(children[i].className) ) {
                    // Prepend with a YARA variable denominator.
                    conditionString += preSpacing + YARA_VARIABLE_DENOMINATOR + children[i].id;
                } else if (KEYWORD_CLASSES.includes(children[i].className)) {
                    // Child is a logical operator
                    conditionString += preSpacing + getEditorElementKeywordText(children[i]).toLowerCase();
                } else {
                    console.error("getEditorConditionString is not supposed to reach an else condition!");
                    console.error(children[i]);
                }
            }

            return conditionString;
        }

        function getEnabledTags() {
            let enabledTags= [];
            let tagCheckboxes = document.getElementsByClassName("yara-tag-checkbox");

            for (let i = 0; i < tagCheckboxes.length; i++) {
                if (tagCheckboxes[i].checked) enabledTags.push(tagCheckboxes[i].value);
            }

            return enabledTags;
        }

        /**
         * Generate a JSON of varname and vardata to send in POST request.
         */
        function getRuleJsonFromEditorElements() {
            let json = {};
            let yaraRule = $('#yaraRule').data();

            // Get rule name.
            let ruleName = yaraRule.name;

            // Set meta FIXME: sub-dicts hardcoded!
            json["meta"] = {"description" : $('#yaraMeta').data().description};

            // Set rule name.
            json["rule"] = ruleName;

            // Set tags.
            json["tags"] = getEnabledTags();

            // Get list of artifacts currently residing in editor DIV.
            json["artifacts"] = {};

            let artifactElements = getEditorArtifactsAndTypes();
            for (let i = 0; i < artifactElements.length; i++) {
                json["artifacts"][YARA_VARIABLE_DENOMINATOR + artifactElements[i].id] = {
                    "artifact": getEditorElementArtifactText(artifactElements[i])
                }
            }

            // Get condition.
            json["condition"] = getEditorConditionString();

            return json;
        }

        function addCaseDetailsCollapsibleButtonLogic(className) {
            let coll = document.getElementsByClassName(className);
            let i;

            for (i = 0; i < coll.length; i++) {
              coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
                let content = this.nextElementSibling;
                if (content.style.display === "block") {
                  content.style.display = "none";
                } else {
                  content.style.display = "block";
                }
              });
            }
        }

        function handlePostRuleResponse(json) {
            let errorType = "";
            let errorMessage = "";
            let errorLineNumber = 0;
            let errorColumnNumber = 0;
            let errorColumnRange = 0;
            let errorWord = "";
            let level = "success";

            // Parse JSON:
            let inJson = json["in"];
            let outJson = json["out"];

            let compilable = outJson["compilable"];
            let success = outJson["success"];

            let source = outJson["source"];
            let sourcePreprocessed = outJson["source (preprocessed)"];

            if (!compilable) {
                level = "warning";
            }

            if (!success) {
                errorMessage = outJson["error"]["message"];
                errorType = outJson["error"]["type"];
                errorLineNumber = parseInt(outJson["error"]["line_number"]);
                errorColumnNumber = parseInt(outJson["error"]["column_number"]);
                errorColumnRange = parseInt(outJson["error"]["column_range"]);
                errorWord = outJson["error"]["word"];
                level = "error";

                console.log("errorMessage: " + errorMessage);
                console.log("errorType: " + errorType);
                console.log("errorLineNumber: " + errorLineNumber);
                console.log("errorColumnNumber: " + errorColumnNumber);
                console.log("errorColumnRange: " + errorColumnRange);
                console.log("errorWord: " + errorWord);
                console.log("level: " + level);
            }

            // Define header
            let header = `<h2>YARA rule generation results: ${String(level).toUpperCase()}</h2>`;

            // Define body
            let body = "";

            // Passed/Failed items.
            body += "<p>" + (compilable === true ? SUCCESS_ICON : FAILED_ICON) + " Compiles </p>";

            // Error message (if any).
            if (!success) {
                body += `<p>${errorType.replace(/^\w/, c => c.toUpperCase())} error message: ${errorMessage}</p>`;
            }

            // Formatted string of the generated YARA rule ("source").
            body += "<br/>Generated YARA rule:<br/>";

            // Loop through lines to add line numbering support via CSS counter.
            let lines = String(sourcePreprocessed).split('\n');
            body += "<pre class='numbered_lines'>";
            for (let i = 0; i < lines.length; i++) {
                if (!success) {
                    if (errorType === "syntax" && i === errorLineNumber-1) {
                        // Color bad column or line.
                        let stringUpToMark = lines[i].substring(0, errorColumnNumber -1);
                        let stringToMark = lines[i].substring(errorColumnNumber -1, errorColumnRange - 1);
                        let stringPastMark = lines[i].substring(errorColumnRange -1, lines[i].length);

                        // console.log("stringUpToMark: " + stringUpToMark);
                        // console.log(`stringToMark: '${stringToMark}'`);
                        // console.log("stringPastMark: " + stringPastMark);

                        lines[i] = `${stringUpToMark}<mark class='red'>${stringToMark}</mark>${stringPastMark}`;
                    }
                }

                // Append line
                body += `<span>${lines[i]}</span>`;
            }
            body += "</pre>";

            // Collapsible raw JSON details.
            body +=
                "<button type='button' class='response-modal-json-collapsible-button'>Show JSON</button>" +
                "<div class='response-modal-json-collapsible-content'>" +
                    "<pre>" +
                        JSON.stringify(json, undefined, 4) +
                    "</pre>" +
                "</div>";

            popupModal("response-modal", header, body, MODAL_DEFAULT_FOOTER, level);
            // Make the JSON detailsCollapsible element actually collapsible.
            addCaseDetailsCollapsibleButtonLogic("response-modal-json-collapsible-button");
        }

        /**
         * Make a custom POST request for non-form elements like DIV and SPAN.
         */
        function postRule() {
            let json = getRuleJsonFromEditorElements();

            let xhr = new XMLHttpRequest();
            let postUrl = $('#postUrl').data().url;

            console.log("POST URL: " + postUrl);

            xhr.open("POST", postUrl, true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            // Add custom handling of the response returned by XHR POST URL.
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    handlePostRuleResponse(JSON.parse(xhr.responseText));
                }
            };

            // Convert a JavaScript value to a JavaScript Object Notation (JSON) string (Required for POST).
            xhr.send(JSON.stringify(json));
        }

        function clearEditorDivContents() {
            let editorDiv = document.getElementById("yara_rule_designer_editor");
            editorDiv.textContent = '';
        }

        function clearRule() {
            // Define body
            let body = "<h3>Are you sure you want to clear the current rule? This is action is <em>irreversible</em>.</h3>";

            // yesAction, noAction, body, args...
            popupConfirmationModal(clearEditorDivContents, undefined, body);
        }

        function makeClone(node) {
            console.log(node);
            let clone;

            // Returns a copy of node. If deep is true, the copy also includes the node's descendants.
            clone = node.cloneNode(true);

            node.parentNode.insertBefore(clone, node);

            return clone;
        }
    </script>
{% endblock %}