<link rel="stylesheet" href="{{ url_for('static', filename='yara_rule_designer.css') }}">

<!--Define variable-->
{% if artifacts is not defined %}
    {% set artifacts = {"data:" : "ERROR: NO ARTIFACTS WERE GIVEN!"} %}
{% endif %}

<!-- Load theme if specified -->
{% if theme is defined %}
    <!-- Set Jinja2 variables for use in JavaScript -->
    <meta id="themeArg" data-name="{{ theme }}" data-path="{{ url_for('static', filename='themes') + '/' }}">
{% endif %}


<div id="yara_rule_designer_header"><p> Case: {{ case.data.title }} [ID: {{ case.data.id }}] </p></div>
<div id="yara_rule_designer_container">
    <div class="yara_rule_designer" id="yara_rule_designer_artifacts" ondrop="drop(event)" ondragover="dragOverDisallowedDrop(event)" ondragenter="dragEnterDenied(event)" ondragleave="dragLeaveDenied(event)">
    <!--    Add artifacts as individual draggable objects-->
        {% for artifact in artifacts %}
            <span id="artifact_{{ loop.index }}" class="draggable_artifact" draggable="true" ondragstart="drag(event)">{{ artifact.data }}</span>
        {% endfor %}
    </div>

    <div class="yara_rule_designer" id="yara_rule_designer_editor" ondrop="drop(event)" ondragover="dragOverAllowedDrop(event)" ondragenter="dragEnterAllowed(event)" ondragleave="dragLeaveAllowed(event)">
        <span id="test" class="draggable_artifact" draggable="true" ondragstart="drag(event)">TEST AREA</span>
    </div>

    <div class="yara_rule_designer" id="yara_rule_designer_operators" ondrop="drop(event)" ondragover="dragOverDisallowedDrop(event)" ondragenter="dragEnterDenied(event)" ondragleave="dragLeaveDenied(event)">
    <!--    Add conditional keywords-->
    <!--    Boolean-->
        <span id="condition_keyword_and" class="condition_keyword" draggable="true" ondragstart="drag(event)">AND</span>
        <span id="condition_keyword_or" class="condition_keyword" draggable="true" ondragstart="drag(event)">OR</span>
        <span id="condition_keyword_not" class="condition_keyword" draggable="true" ondragstart="drag(event)">NOT</span>
    <!--    Arithmetic-->
        <span id="condition_keyword_equal" class="condition_keyword" draggable="true" ondragstart="drag(event)">==</span>
        <span id="condition_keyword_lt" class="condition_keyword" draggable="true" ondragstart="drag(event)"><</span>
        <span id="condition_keyword_gt" class="condition_keyword" draggable="true" ondragstart="drag(event)">></span>
        <span id="condition_keyword_leq" class="condition_keyword" draggable="true" ondragstart="drag(event)"><=</span>
        <span id="condition_keyword_geq" class="condition_keyword" draggable="true" ondragstart="drag(event)">>=</span>
        <span id="condition_keyword_neq" class="condition_keyword" draggable="true" ondragstart="drag(event)">!=</span>
    <!--    Relational-->
        <span id="condition_keyword_add" class="condition_keyword" draggable="true" ondragstart="drag(event)">+</span>
        <span id="condition_keyword_sub" class="condition_keyword" draggable="true" ondragstart="drag(event)">-</span>
        <span id="condition_keyword_mul" class="condition_keyword" draggable="true" ondragstart="drag(event)">*</span>
        <span id="condition_keyword_div" class="condition_keyword" draggable="true" ondragstart="drag(event)">/</span>
        <span id="condition_keyword_pct" class="condition_keyword" draggable="true" ondragstart="drag(event)">%</span>
        <span id="condition_keyword_setminus" class="condition_keyword" draggable="true" ondragstart="drag(event)">\</span>
    <!--    Bitwise-->
        <span id="condition_keyword_bitwise_and" class="condition_keyword" draggable="true" ondragstart="drag(event)">&</span>
        <span id="condition_keyword_bitwise_or" class="condition_keyword" draggable="true" ondragstart="drag(event)">|</span>
        <span id="condition_keyword_bitwise_not" class="condition_keyword" draggable="true" ondragstart="drag(event)">~</span>
        <span id="condition_keyword_bitwise_xor" class="condition_keyword" draggable="true" ondragstart="drag(event)">^</span>
        <span id="condition_keyword_bitwise_lshift" class="condition_keyword" draggable="true" ondragstart="drag(event)"><<</span>
        <span id="condition_keyword_bitwise_rshift" class="condition_keyword" draggable="true" ondragstart="drag(event)">>></span>
    </div>
</div>

{% block javascript %}
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-2.1.0.min.js"></script>

    <script>
        // extend jQuery with this tiny convenience to allow for simple existence tests.
        $.fn.exists = function () {
            return this.length !== 0;
        };

        function loadTheme(themeData) {
            const rootEl = document.querySelector(':root');
            const themePath = themeData.path;

            var themeFile = themeData.name + ".json";
            var themeFilePath = themePath + themeFile;

            // Load corresponding theme JSON from file.
            console.log("Load theme: " + themeFilePath);
            $.getJSON(themeFilePath, function(json) {
                console.log(json); // this will show the info it in firebug console
                for (var key in json) {
                    console.log("setProperty(" + key + ", " + json[key] + ")")
                    rootEl.style.setProperty(key, json[key]);
                }

            });
        }

        if ($('#themeArg').exists()) {
            loadTheme($('#themeArg').data())
        }
    </script>

    <script>
        // https://stackoverflow.com/a/26272668
        function getStyleRuleValue(selector, style) {
         var selector_compare=selector.toLowerCase();
         var selector_compare2= selector_compare.substr(0,1)==='.' ?  selector_compare.substr(1) : '.'+selector_compare;

         for (var i = 0; i < document.styleSheets.length; i++)
         {
          var mysheet = document.styleSheets[i];
          var myrules = mysheet.cssRules ? mysheet.cssRules : mysheet.rules;

          for (var j = 0; j < myrules.length; j++)
          {
            if (myrules[j].selectorText)
            {
             var check = myrules[j].selectorText.toLowerCase();
             switch (check)
             {
              case selector_compare  :
              case selector_compare2 : return myrules[j].style[style];
             }
            }
           }
          }
         }

        const ALLOWED_ITEM_COLOR = '#229954';
        const DENIED_ITEM_COLOR = '#c0392b';
        const CLASSES_NOT_TO_COLOR = ['yara_rule_designer'];

        function colorHoveredItem(hoveredItemToColor, color) {
            /**
             * Colors a hovered object.
             */

            if (typeof hoveredItemToColor == "undefined") {
                console.log("FAILED Coloring (hoveredItemToColor was undefined!)'");
                return;
            }
            console.log("hoveredItemToColor:");
            console.log(hoveredItemToColor);

            console.log("Coloring '" + $(hoveredItemToColor).text() + "': " + color);

            hoveredItemToColor.style.background = color;
        }

        function hasRelatedTarget(ev) {
            /**
             * Because null == undefined is true, this will catch both null and undefined.
             */
            return ev.relatedTarget != null;
        }

        function hasTarget(ev) {
            /**
             * Because null == undefined is true, this will catch both null and undefined.
             */
            return ev.target != null;
        }

        function isNotToBeColored(ev) {
            try {
                // Check if object inherits a class that's not to be colored
                console.log("Ignore coloring obj: '" + ev.target.id + "' of class '" + ev.target.getAttribute('class'));
                return CLASSES_NOT_TO_COLOR.includes(ev.target.getAttribute('class'));
            } catch (err) {
                // If anything goes wrong, assume the object it not to be colored.
                console.log("isNotToBeColored EXCEPTION: " + err.message);
                console.log(ev);
                return true;
            }
        }

        function dragEnterDenied(ev) {
            if (isNotToBeColored(ev) === true) {
                return;
            }

            console.log('Forbidden drop target (enter): ' + $(ev.target).text());
            console.log(ev);

            // Make sure event is hovering a valid droppable object (has a relatedTarget property).
            console.log("hasRelatedTarget: " + hasRelatedTarget(ev));
            if (hasRelatedTarget(ev) === true) {
                colorHoveredItem(ev.target, DENIED_ITEM_COLOR);
            }
        }

        function resetColoredObject(ev) {
            /**
             * Resets a colored hoveredItem object back to its original style (using its class as reference)
             */
            // Get the item that is being hovered over (NB: target not relatedTarget on ondragleave).
            if (hasTarget(ev) === true) {
                var hoveredItem = ev.target;
            } else {
                console.log("resetColoredObject: ABORTED! Was given object with no target properly:");
                console.log(ev);
                return;
            }
            console.log("hoveredItem:");
            console.log(hoveredItem);

            // Get its class.
            var hoveredItemClass = hoveredItem.getAttribute("class");
            console.log("hoveredItemClass: " + hoveredItemClass);
            // Use the class name to determine its original color setting.
            var originalColor = getStyleRuleValue('.' + hoveredItemClass, 'backgroundColor');
            console.log("originalColor: " + originalColor);

            console.log("Reset color on '" + $(hoveredItem).text().replace(/(\r\n|\n|\r)/gm,"") + "': " + originalColor);
            colorHoveredItem(hoveredItem, originalColor);
        }

        function dragLeaveDenied(ev) {
            console.log("dragLeaveDenied: isNotToBeColored: " + isNotToBeColored(ev));
            if (isNotToBeColored(ev) === true) {
                return;
            }

            console.log('Forbidden drop target (leave): ' + $(ev.target).text());
            console.log(ev);

            // Reset color.
            resetColoredObject(ev);
        }

        function dragEnterAllowed(ev) {
            console.log('Allowed drop target (enter): ' + $(ev.target).text());

            if (isNotToBeColored(ev) !== true) {
                colorHoveredItem(ev.target, ALLOWED_ITEM_COLOR);
            }

        }

        function dragLeaveAllowed(ev) {
            console.log('Allowed drop target (leave): ' + $(ev.target).text());

            if (isNotToBeColored(ev) === true) {
                return;
            }

            // Reset color.
            resetColoredObject(ev);
        }

        function dragOverAllowedDrop(ev) {
            console.log('Allowed drop target (hover): ' + $(ev.target).text());

            // By default, data/elements cannot be dropped in other elements.
            // To allow a drop, we must prevent the default handling of the element.
            ev.preventDefault();
        }

        function dragOverDisallowedDrop(ev) {
            console.log('Forbidden drop target (hover): ' + $(ev.target).text().replace(/(\r\n|\n|\r)/gm,""));
        }

        function drag(ev)  {
            console.log('drag ' + $(ev.target).text());

            // Tells the browser that only the listed type(s) of operations are allowed for the user.
            ev.dataTransfer.effectAllowed = "copy";

            // Add this element's id to the drag payload so the drop handler will
            // know which element to add to its tree
            ev.dataTransfer.setData("Text",ev.target.id);
        }

        function drop(ev) {
            console.log('drop ' + $(ev.target).text());

            // Reset color.
            resetColoredObject(ev);

            ev.preventDefault();
            var data=ev.dataTransfer.getData("Text");

            ev.target.appendChild(document.getElementById(data));

            // Text append to existing obj
            // var currentText = $(ev.target).text();
            // $(ev.target).text(currentText + ' ' + $('#' + data).text());
            // $('#' + data).remove();
        }
    </script>
{% endblock %}