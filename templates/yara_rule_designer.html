<title>YARA Rule Designer: {{ case.data.title }}</title>
{# <!--suppress HtmlUnknownTarget --> #}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/yara_rule_designer.css') }}">

{# Define default values for variables #}
{% if artifacts is not defined %}
    {% set artifacts = {"data:" : "ERROR: NO ARTIFACTS WERE GIVEN!"} %}
{% endif %}

    <!-- Set Jinja2 variables for use in JavaScript -->
{# Load theme if specified #}
{% if theme is defined %}
    <!--    Theme handler: -->
    <meta id="themeArg" data-name="{{ theme }}" data-path="{{ url_for('static', filename='themes') + '/' }}">
{% endif %}
<!--    JavaScript custom POST handlers -->
<meta id="postDesignedRuleUrl" data-url="{{ url_for('post_rule_json') }}">
<meta id="postCommitUrl" data-url="{{ url_for('post_commit_json') }}">
<!--    YARA rule variables gathered from backend for use in POST request -->
<meta id="yaraRule" data-name="Whitelist_{{ case.data.title }}" data-tags="{{ case.data.tags }}" data-id="{{ case.data.id }}">
<meta id="yaraMeta" data-description="Whitelist regler for alarmen: Whitelist_{{ case.data.title }}">

{#  Add artifacts and artifact dataTypes as individual draggable objects #}

{# Define list to filter artifact types so that only unique occurrences are added. #}
{% set added_artifact_types = [] %}

{# For use in adding the HTML at a later time, to avoid looping multiple times. #}
{% set artifact_span_elements = [] %}
{% set artifact_type_span_elements = [] %}

{% for artifact in artifacts %}
    {# Add artifacts #}
    {{ artifact_span_elements.append("<span id='artifact" + loop.index|string + "' class='draggable_artifact' onclick='addToEditor(event)'>" + artifact.data|string + '</span>')|ignore_none }}

    {# Add artifact dataTypes #}
    {# Remove NoneType entries by assigning the value to a new variable, if it is not NoneType. #}
    {% if artifact.dataType is not none and artifact.dataType != "None" %}
        {# Only add unique items to editor #}
        {% if artifact.dataType not in added_artifact_types %}

            {# Add artifact types #}
            {{ artifact_type_span_elements.append('<span id="artifact_type' + loop.index|string + '" class="draggable_artifact_type" onclick="addToEditor(event)">' + artifact.dataType|string + '</span>')|ignore_none }}
            {{ added_artifact_types.append(artifact.dataType)|ignore_none }}
        {% endif %}
    {% endif %}
{% endfor %}

<div class="container mh-100 h-100 mw-100 w-100 yara_rule_designer" id="yara_rule_designer_container">
    <div class="row align-items-start">

        <div id="yara_rule_designer_header" class="col yara_rule_designer">
            <p> Case: {{ case.data.title }} [ID: {{ case.data.id }}] </p>
        </div>

        <div class="w-100"></div>

        <div id="yara_rule_designer_leftpane_container" class="col-2 yara_rule_designer">
            <div class="row">
                <div class="row m-row justify-content-between yara_rule_designer" id="yara-rule-designer-buttons">
                    <button id="load-rule-button" class="col-sm my-col" onclick="loadRuleDialog()">Open</button>
                    <button id="show-help-button" class="col-sm my-col" onclick="popupHelpModal()">Help</button>
                    <button id="clear-rule-button" class="col-sm my-col" onclick="clearRule()">Clear</button>
                    <button id="submit-rule-button" class="col-sm my-col" onclick="postRule()">Submit</button>
                </div>

                <div class="w-100"></div>

                <div id="yara-rule-designer-tags" class="yara_rule_designer">
                    {% for tag in case.data.tags %}
                        <input type="checkbox" id="tagCheckbox{{ loop.index|string }}" class="yara-tag-checkbox" value="{{ tag|string }}">
                        <label for="tagCheckbox{{ loop.index|string }}" title="{{ tag|string }}">{{ tag|string }}</label>
                        <div class="w-100"></div>
                    {% endfor %}
                </div>

                <div class="w-100"></div>

                <div class="yara_rule_designer" id="yara_rule_designer_operators">
                    <!--    Add conditional keywords-->
                    <!--    Boolean-->
                    <span id="condition_keyword_and" class="condition_keyword" onclick="addToEditor(event)">AND</span>
                    <span id="condition_keyword_or" class="condition_keyword" onclick="addToEditor(event)">OR</span>
                    <span id="condition_keyword_not" class="condition_keyword" onclick="addToEditor(event)">NOT</span>
                    <!--    Arithmetic-->
                    <span id="condition_keyword_equal" class="condition_keyword" onclick="addToEditor(event)">==</span>
                    <span id="condition_keyword_lt" class="condition_keyword" onclick="addToEditor(event)"><</span>
                    <span id="condition_keyword_gt" class="condition_keyword" onclick="addToEditor(event)">></span>
                    <span id="condition_keyword_leq" class="condition_keyword" onclick="addToEditor(event)"><=</span>
                    <span id="condition_keyword_geq" class="condition_keyword" onclick="addToEditor(event)">>=</span>
                    <span id="condition_keyword_neq" class="condition_keyword" onclick="addToEditor(event)">!=</span>
                    <!--    Relational-->
                    <span id="condition_keyword_add" class="condition_keyword" onclick="addToEditor(event)">+</span>
                    <span id="condition_keyword_sub" class="condition_keyword" onclick="addToEditor(event)">-</span>
                    <span id="condition_keyword_mul" class="condition_keyword" onclick="addToEditor(event)">*</span>
                    <span id="condition_keyword_div" class="condition_keyword" onclick="addToEditor(event)">/</span>
                    <span id="condition_keyword_pct" class="condition_keyword" onclick="addToEditor(event)">%</span>
                    <span id="condition_keyword_setminus" class="condition_keyword" onclick="addToEditor(event)">\</span>
                    <!--    Bitwise-->
                    <span id="condition_keyword_bitwise_and" class="condition_keyword" onclick="addToEditor(event)">&</span>
                    <span id="condition_keyword_bitwise_or" class="condition_keyword" onclick="addToEditor(event)">|</span>
                    <span id="condition_keyword_bitwise_not" class="condition_keyword" onclick="addToEditor(event)">~</span>
                    <span id="condition_keyword_bitwise_xor" class="condition_keyword" onclick="addToEditor(event)">^</span>
                    <span id="condition_keyword_bitwise_lshift" class="condition_keyword" onclick="addToEditor(event)"><<</span>
                    <span id="condition_keyword_bitwise_rshift" class="condition_keyword" onclick="addToEditor(event)">>></span>
                    <!-- Parenthesis and wrappers       -->
                    <span id="condition_keyword_lparen" class="condition_keyword" onclick="addToEditor(event)">(</span>
                    <span id="condition_keyword_rparen" class="condition_keyword" onclick="addToEditor(event)">)</span>
                    <span id="condition_keyword_encapsulate_paren" class="condition_encapsulator" onclick="addToEditor(event)">()</span>
                </div>

                <div class="w-100"></div>

                <div class="yara_rule_designer" id="yara_rule_designer_artifact_types">
                    {% for artifact_type_span_element in artifact_type_span_elements %}
                        {{ artifact_type_span_element|safe }}
                    {% endfor %}
                </div>

                <div class="w-100"></div>

                <div class="yara_rule_designer" id="yara_rule_designer_artifacts">
                    {% for artifact_span_element in artifact_span_elements %}
                        {{ artifact_span_element|safe }}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div id="yara_rule_designer_editor_container" class="col-10 yara_rule_designer">
            <div class="row">
                <div class="container col yara_rule_designer" id="yara_rule_designer_editor"></div>
            </div>
        </div>

    </div> {# Row #}
</div> {# Container #}

<!-- Pre-define default modals (to be populated by JavaScript later). -->
<div id="response-modal" class="custom-modal">
    <!-- Modal content -->
    <div class="custom-modal-content">
      <div class="custom-modal-header" id="response-modal-header">
        <span class="close-custom-modal" id="response-modal-close">&times;</span>
        <h2>Modal Header</h2>
      </div>
      <div class="custom-modal-body" id="response-modal-body">
        <p>Some text in the Modal Body</p>
        <p>Some other text...</p>
      </div>
      <div class="custom-modal-footer" id="response-modal-footer">
        <h3>Modal Footer</h3>
      </div>
    </div>
</div>

<div id="confirmation-modal" class="custom-modal">
    <!-- Modal content -->
    <div class="custom-modal-content">
        <div class="custom-modal-header" id="confirmation-modal-header">
            <span class="close-custom-modal" id="confirmation-modal-close">&times;</span>
            <h2>Modal Header</h2>
        </div>
        <div class="custom-modal-body" id="confirmation-modal-body">
            <p>Some text in the Modal Body</p>
            <p>Some other text...</p>
        </div>
        <div class="custom-modal-footer" id="confirmation-modal-footer">
            <h3>Modal Footer</h3>
        </div>
    </div>
</div>

{% block javascript %}
    <!-- JQuery ( required for Bootstrap and $() ). -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT" crossorigin="anonymous"></script>

    <!-- Popper ( required for Bootstrap ). -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    <!-- Dragula - Drag 'n Drop   -->
    <!--suppress HtmlUnknownTarget -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/dragula.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js" integrity="sha384-BCXeg8w0rlmhmi8L/zjAIsj0b66prXjptd1vMdGJbEVJH5aBJYDjzfdTmWBzcCXG" crossorigin="anonymous"></script>

    <!-- Theme handler -->
    {# <!--suppress HtmlUnknownTarget --> #}
    <script src="{{ url_for('static', filename='scripts/themes.js') }}"></script>

    <!-- Core Designer script block -->
    {# <!--suppress HtmlUnknownTarget --> #}
    <script src="{{ url_for('static', filename='scripts/designer.js') }}"></script>
{% endblock %}