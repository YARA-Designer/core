<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

<div class="block1">
    <h1> Case: {{ case.data.title }} [ID: {{ case.data.id }}] </h1>
    <h2>Severity: {{ case.data.severity }}</h2>
    <h4>Tags: {{ case.data.tags }}</h4>
    {% if case.data.customFields %}
        <h5>Custom fields: {{ case.data.customFields }}</h5>
    {% endif %}

    <form action="{{ url_for('post_rule') }}" method="post">
        <table>
            <tr>
                <th>Variable ref.</th>
                <th>Artifact</th>
                <th>Type</th>
                <th>ID</th>
            </tr>
                {% for key, value in case.data.items() %}
                    {% if key == "observables" %}
                            <td>

                                {% for observable in case.data.observables %}
                                    <tr>
                                      <td>
                                          <p class="artifact_varname" id="artifact_{{ loop.index }}">
                                              $artifact{{ loop.index }}
                                          </p>
                                      </td>
                                      <td>
                                          <p id="artifact">
                                              {{ observable.data }}
                                          </p>
                                      </td>
                                      <td>
                                          <p id="artifactType">
                                              {{ observable.dataType }}
                                          </p>
                                      </td>
                                      <td>
                                          <p id="artifactId">
                                              {{ observable.id }}
                                          </p>
                                      </td>
                                    </tr>
                                {% endfor %}
                            </td>
                    {% endif %}
                {% endfor %}
        </table>
        <div class="raw_yara_condition_input" id="raw_yara_condition_input" contentEditable="true"
             onblur="onDivBlur();" onmousedown="return cancelEvent(event);" onclick="return cancelEvent(event);"
             onmouseup="saveSelection();" onkeyup="saveSelection();" onfocus="restoreSelection();"></div>
        <input type="submit" value="Submit (RAW)">
    </form>
</div>

<!-- DETAILS SECTION //-->
<button type="button" class="caseDetailsCollapsible">Show case details</button>
<div class="caseDetailsContent">
    <table>
        <tr>
            <th>Key</th>
            <th>Value</th>
        </tr>
        {% for key, value in case.data.items() %}
            {% if key != "observables" %}
                <tr>
                    <td> {{ key }} </td>
                    <td>{{ value }}</td>
                </tr>
            {% endif %}
        {% endfor %}
    </table>
</div>

{% block javascript %}
    <!--        Add custom styling for each artifact_# -->
    <script type="text/javascript">
        // Fix caret position reset issues with contenteditable div elements-->
        // src: https://stackoverflow.com/a/3323835 -->
        var savedRange,isInFocus;

        function saveSelection()
        {
            if(window.getSelection)//non IE Browsers
            {
                savedRange = window.getSelection().getRangeAt(0);
            }
            else if(document.selection)//IE
            {
                savedRange = document.selection.createRange();
            }
        }

        function restoreSelection()
        {
            isInFocus = true;
            document.getElementById("raw_yara_condition_input").focus();
            if (savedRange != null) {
                if (window.getSelection)//non IE and there is already a selection
                {
                    var s = window.getSelection();
                    if (s.rangeCount > 0)
                        s.removeAllRanges();
                    s.addRange(savedRange);
                }
                else if (document.createRange)//non IE and no selection
                {
                    window.getSelection().addRange(savedRange);
                }
                else if (document.selection)//IE
                {
                    savedRange.select();
                }
            }
        }
        //this part onwards is only needed if you want to restore selection onclick
        var isInFocus = false;
        function onDivBlur()
        {
            isInFocus = false;
        }

        function cancelEvent(e)
        {
            if (isInFocus == false && savedRange != null) {
                if (e && e.preventDefault) {
                    //alert("FF");
                    e.stopPropagation(); // DOM style (return false doesn't always work in FF)
                    e.preventDefault();
                }
                else {
                    window.event.cancelBubble = true;//IE stopPropagation
                }
                restoreSelection();
                return false; // false = IE style
            }
        }

        function placeCaretAtEnd(el) {
            el.focus();
            if (typeof window.getSelection != "undefined"
                    && typeof document.createRange != "undefined") {
                var range = document.createRange();
                range.selectNodeContents(el);
                range.collapse(false);
                var sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            } else if (typeof document.body.createTextRange != "undefined") {
                var textRange = document.body.createTextRange();
                textRange.moveToElementText(el);
                textRange.collapse(false);
                textRange.select();
            }
        }

        // -------------- THE DIVIDE ----------------

        var colors = ['#1f618d', '#0074D9', '#7FDBFF', '#a9a70f', '#39CCCC', '#3D9970',
            '#2ECC40', '#01FF70', '#FF851B', '#FF4136', '#85144b', '#F012BE', '#B10DC9', '#17a589'];
        var color_pos = 0;
        var artifact_color = {};
        var artifact_colors_pos = [];

        // Get the element with class="artifact_varname", then get all members.
        var elements = document.getElementsByClassName('artifact_varname');
        // console.log(elements);

        function createCSSClass(name, rules){
            var style = document.createElement('style');
            style.type = 'text/css';
            document.getElementsByTagName('head')[0].appendChild(style);
            if(!(style.sheet||{}).insertRule)
                (style.styleSheet || style.sheet).addRule(name, rules);
            else
                style.sheet.insertRule(name+"{" + rules + "}",0);
        }

        // Create a for loop and set the border of all <a> elements with a target attribute in div
        var i;
        for (i = 0; i < elements.length; i++) {
            // console.log(elements[i]);
            // Set color for the <p> element.
            elements[i].style.color = colors[color_pos];

            // Store varname: color to JSON for later use (e.g. input colorization).
            artifact_color[elements[i].innerText] = colors[color_pos];  // ex: ["$artifact4"] = '#a9a70f'
            artifact_colors_pos[elements[i].innerText] = color_pos;     // ex: ["$artifact4"] = 3

            // Create a CSS class for the specific artifact and its color for later use.
            createCSSClass('.generatedArtifactColor' + color_pos,"color: " + colors[color_pos] + ";");

            // Increment color cursor, loop around if end is reached.
            if (color_pos === colors.length -1) {
              color_pos = 0
            } else {
              color_pos++;
            }
        }

        var sDiv=document.getElementById('raw_yara_condition_input');
        sDiv.onkeypress=function(){
            setTimeout(function(){
                // The setTimeout is so the content is inserted before execution
                saveSelection();
                document.getElementById('raw_yara_condition_input').value=sDiv.textContent;

                // console.log(sDiv.innerHTML);
                var words = sDiv.innerHTML.split(' ');
                console.log(words);

                // Destructively modifies word if it matches colorize requirments.
                words.forEach(function(word) {
                    // Only proceed if word is a potential varname reference.
                    if (word.startsWith('$')) {
                        if (artifact_color.hasOwnProperty(word)) {
                            // Modify the current word to be wrapped in a color span.
                            sDiv.innerHTML=sDiv.innerHTML.replace(word,'<span style="color:' + artifact_color[word] +
                                '">' + word + '</span>');

                            // placeCaretAtEnd(document.getElementById('raw_yara_condition_textarea'));
                            restoreSelection();
                            // document.getElementById("raw_yara_condition_textarea").focus();
                        }
                    }
                }); // Use words as keyword:this
                // Workaround for caret resetting after each replace; Always put caret at end of string after replace.
                // placeCaretAtEnd( document.querySelector('p') );
            },50);
        }
    </script>

    <script type="text/javascript">
        var coll = document.getElementsByClassName("caseDetailsCollapsible");
        var i;

        for (i = 0; i < coll.length; i++) {
          coll[i].addEventListener("click", function() {
            this.classList.toggle("active");
            var content = this.nextElementSibling;
            if (content.style.display === "block") {
              content.style.display = "none";
            } else {
              content.style.display = "block";
            }
          });
        }
    </script>
{% endblock %}

{% set artifacts = case.data.observables %}
{% include 'yara_rule_designer.html' %}
